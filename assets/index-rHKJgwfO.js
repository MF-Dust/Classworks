import{V as ie,M as Ze,a as $e,b as et,d as fe,p as we,u as Ce}from"./VAppBarTitle-7VHFwA_r.js";import{g as H,p as R,h as J,i as tt,j as at,k as V,l as he,n as j,b as W,q as Ve,c as s,s as nt,t as $,v as st,_ as Be,x as y,y as X,f as _,o as f,w as o,z as h,A as Y,B as b,C as v,D as w,E as I,F as it,G as k,T as pe,H as F,I as O,J as lt,K as rt,L as ye,M as de,N as be,O as ze,P as xe,Q as ot,R as le,S as ue,U as ce,W as Re,X as Ue,Y as Ge,Z as dt,$ as ut,a0 as ct,a1 as ht,a2 as Ye,a3 as mt,u as ft,a4 as vt,a5 as gt,a6 as kt,a7 as pt,a8 as yt,m as bt,a9 as xt,aa as St,ab as Dt,ac as wt,d as Ct,e as Vt,ad as Pt,ae as At,af as _t,ag as Mt,ah as Lt,r as Pe,ai as Ae,aj as ve,ak as Ft,al as re,am as Tt,an as _e}from"./index-CXuoiuhD.js";import{V as N,a as q,b as E,c as Ot,d as jt,e as oe,f as Nt,g as ge,h as Et,i as ke}from"./VRow-B1eTMxyG.js";import{V as Q,a as K,b as It,c as Me,d as Le,e as Bt,f as zt,g as Rt}from"./VSpacer-C8ryX8xR.js";import{V as Ut,a as Gt,b as Yt}from"./VTextarea-bIMyRqfe.js";import"./ssrBoot-m1Fxwm88.js";const Ht=R({id:String,interactive:Boolean,text:String,...$(st({closeOnBack:!1,location:"end",locationStrategy:"connected",eager:!0,minWidth:0,offset:10,openOnClick:!1,openOnHover:!0,origin:"auto",scrim:!1,scrollStrategy:"reposition",transition:!1}),["absolute","persistent"])},"VTooltip"),He=H()({name:"VTooltip",props:Ht(),emits:{"update:modelValue":e=>!0},setup(e,t){let{slots:n}=t;const r=J(e,"modelValue"),{scopeId:a}=tt(),l=at(),d=V(()=>e.id||`v-tooltip-${l}`),u=he(),i=V(()=>e.location.split(" ").length>1?e.location:e.location+" center"),c=V(()=>e.origin==="auto"||e.origin==="overlap"||e.origin.split(" ").length>1||e.location.split(" ").length>1?e.origin:e.origin+" center"),g=V(()=>e.transition?e.transition:r.value?"scale-transition":"fade-transition"),C=V(()=>j({"aria-describedby":d.value},e.activatorProps));return W(()=>{const L=Ve.filterProps(e);return s(Ve,j({ref:u,class:["v-tooltip",{"v-tooltip--interactive":e.interactive},e.class],style:e.style,id:d.value},L,{modelValue:r.value,"onUpdate:modelValue":m=>r.value=m,transition:g.value,absolute:!0,location:i.value,origin:c.value,persistent:!0,role:"tooltip",activatorProps:C.value,_disableGlobalStack:!0},a),{activator:n.activator,default:function(){var T;for(var m=arguments.length,p=new Array(m),D=0;D<m;D++)p[D]=arguments[D];return((T=n.default)==null?void 0:T.call(n,...p))??e.text}})}),nt({},u)}}),Wt={name:"RandomPicker",props:{studentList:{type:Array,required:!0},attendance:{type:Object,required:!0,default:()=>({absent:[],late:[],exclude:[]})}},data(){return{dialog:!1,count:y("randomPicker.defaultCount"),pickingMode:"individual",numberOfGroups:y("randomPicker.numberOfGroups"),isPickingStarted:!1,isAnimating:!1,pickedStudents:[],pickedGroups:[],animationStudents:[],highlightedIndices:[],animationTimer:null,getSetting:y,tempFilters:{excludeAbsent:y("randomPicker.excludeAbsent"),excludeLate:y("randomPicker.excludeLate"),excludeExcluded:y("randomPicker.excludeExcluded")}}},computed:{absentCount(){return this.attendance.absent?this.attendance.absent.length:0},lateCount(){return this.attendance.late?this.attendance.late.length:0},excludedCount(){return this.attendance.exclude?this.attendance.exclude.length:0},filteredStudents(){return!this.studentList||!this.studentList.length?[]:this.studentList.filter(e=>!(this.tempFilters.excludeAbsent&&this.attendance.absent.includes(e)||this.tempFilters.excludeLate&&this.attendance.late.includes(e)||this.tempFilters.excludeExcluded&&this.attendance.exclude.includes(e)))},availableStudents(){return this.filteredStudents},maxAllowedCount(){if(this.pickingMode==="individual")return Math.min(y("randomPicker.maxCount"),this.filteredStudents.length);{const e=X["randomPicker.numberOfGroups"].validate?X["randomPicker.numberOfGroups"].validate(10)?10:2:10;return Math.min(e,Math.floor(this.filteredStudents.length/2))}},minAllowedCount(){return this.pickingMode==="individual"?1:2},countLabel(){return this.pickingMode==="individual"?"人数":"组数"},startDisabled(){return this.pickingMode==="individual"?this.filteredStudents.length===0||this.count>this.filteredStudents.length:this.filteredStudents.length<this.numberOfGroups||this.numberOfGroups<2},remainingStudents(){return this.filteredStudents.filter(e=>!this.pickedStudents.includes(e))}},watch:{dialog(e){e?(this.count=y("randomPicker.defaultCount"),this.isPickingStarted=!1,this.isAnimating=!1,this.pickedStudents=[],this.tempFilters={excludeAbsent:y("randomPicker.excludeAbsent"),excludeLate:y("randomPicker.excludeLate"),excludeExcluded:y("randomPicker.excludeExcluded")}):this.animationTimer&&(clearTimeout(this.animationTimer),this.animationTimer=null)},tempFilters:{handler(){this.count>this.maxAllowedCount&&(this.count=Math.max(1,this.maxAllowedCount))},deep:!0}},methods:{open(){this.dialog=!0,this.resetPicker(!1),this.count=y("randomPicker.defaultCount"),this.numberOfGroups=y("randomPicker.numberOfGroups"),this.tempFilters.excludeAbsent=y("randomPicker.excludeAbsent"),this.tempFilters.excludeLate=y("randomPicker.excludeLate"),this.tempFilters.excludeExcluded=y("randomPicker.excludeExcluded")},decrementCount(){this.pickingMode==="individual"&&this.count>1?this.count--:this.pickingMode==="group"&&this.numberOfGroups>this.minAllowedCount&&this.numberOfGroups--},incrementCount(){this.pickingMode==="individual"&&this.count<this.maxAllowedCount?this.count++:this.pickingMode==="group"&&this.numberOfGroups<this.maxAllowedCount&&this.numberOfGroups++},startPicking(){this.startDisabled||(this.isPickingStarted=!0,this.pickedStudents=[],this.pickedGroups=[],this.pickingMode==="individual"?this.startIndividualPicking():this.startGroupPicking())},startIndividualPicking(){y("randomPicker.animation")&&this.count>0?(this.isAnimating=!0,this.runAnimation(()=>{this.pickStudents(),this.isAnimating=!1})):(this.pickStudents(),this.isAnimating=!1)},startGroupPicking(){this.isAnimating=!1,this.pickGroups()},pickStudents(){const e=[...this.filteredStudents].sort(()=>.5-Math.random());this.pickedStudents=e.slice(0,this.count)},pickGroups(){if(this.filteredStudents.length<this.numberOfGroups||this.numberOfGroups<2){console.error("无法分组，学生人数不足或组数无效"),this.pickedGroups=[];return}let e=[...this.filteredStudents].sort(()=>.5-Math.random());const t=Array.from({length:this.numberOfGroups},()=>[]);let n=0;e.forEach(r=>{t[n].push(r),n=(n+1)%this.numberOfGroups}),this.pickedGroups=t},runAnimation(e){let n=0;const r=50,a=()=>{this.highlightedIndices=[];const l=[];for(let u=0;u<this.count;u++){let i;do i=Math.floor(Math.random()*this.animationStudents.length);while(l.includes(i));l.push(i)}this.highlightedIndices=l,n++;const d=r+n*20;n<5?this.animationTimer=setTimeout(a,d):setTimeout(()=>{this.finishPicking()},500)};a()},finishPicking(){this.isAnimating=!1;const e=[...this.filteredStudents].sort(()=>.5-Math.random());this.pickedStudents=e.slice(0,this.count)},resetPicker(){this.isPickingStarted=!1,this.isAnimating=!1,this.pickedStudents=[],this.pickedGroups=[],this.animationStudents=[],this.highlightedIndices=[],clearTimeout(this.animationTimer),this.count=y("randomPicker.defaultCount"),this.numberOfGroups=y("randomPicker.numberOfGroups"),resetFilters&&(this.tempFilters.excludeAbsent=y("randomPicker.excludeAbsent"),this.tempFilters.excludeLate=y("randomPicker.excludeLate"),this.tempFilters.excludeExcluded=y("randomPicker.excludeExcluded"))}}},qt={class:"text-h6 mb-4"},Kt={class:"d-flex justify-center align-center counter-container"},Jt={class:"count-display mx-8"},Xt={class:"text-h2 font-weight-bold"},Qt={class:"text-subtitle-1 ml-2"},Zt={class:"mt-4"},$t={key:0,class:"mt-4 text-warning"},ea={key:1,class:"mt-4 text-error"},ta={class:"mt-4 text-caption"},aa={class:"pa-2"},na={key:0},sa={key:1},ia={key:2},la={class:"d-flex flex-wrap justify-center gap-2 mt-4"},ra={key:0,class:"animation-container"},oa={class:"animation-wrapper"},da={key:1,class:"result-display"},ua={key:0},ca={key:1},ha={key:0,class:"text-grey"},ma={class:"mt-8 d-flex justify-center"};function fa(e,t,n,r,a,l){return f(),_(ie,{modelValue:a.dialog,"onUpdate:modelValue":t[7]||(t[7]=d=>a.dialog=d),"max-width":"600","fullscreen-breakpoint":"sm"},{default:o(()=>[s(N,{class:"random-picker-card"},{default:o(()=>[s(q,{class:"text-h5 d-flex align-center"},{default:o(()=>[s(Y,{icon:"mdi-account-question",class:"mr-2"}),t[8]||(t[8]=h(" 随机抽选 ")),s(Q),s(b,{icon:"mdi-close",variant:"text",onClick:t[0]||(t[0]=d=>a.dialog=!1)})]),_:1}),a.isPickingStarted?(f(),_(E,{key:1,class:"text-center py-6"},{default:o(()=>[a.isAnimating&&a.pickingMode==="individual"?(f(),w("div",ra,[v("div",oa,[s(pe,{name:"shuffle",tag:"div",class:"shuffle-container"},{default:o(()=>[(f(!0),w(F,null,O(a.animationStudents,(d,u)=>(f(),w("div",{key:d.id,class:lt(["student-item",{highlighted:a.highlightedIndices.includes(u)}])},k(d.name),3))),128))]),_:1})])])):(f(),w("div",da,[t[14]||(t[14]=v("div",{class:"text-h6 mb-4"},"抽取结果",-1)),a.pickingMode==="individual"?(f(),w("div",ua,[(f(!0),w(F,null,O(a.pickedStudents,(d,u)=>(f(),_(N,{key:u,variant:"outlined",color:"primary",class:"mb-2 result-card"},{default:o(()=>[s(E,{class:"text-h4 text-center py-4 d-flex align-center justify-center"},{default:o(()=>[h(k(d)+" ",1),s(b,{icon:"mdi-refresh",variant:"text",size:"small",class:"ml-2 refresh-btn",onClick:i=>e.refreshSingleStudent(u),disabled:l.remainingStudents.length===0,title:l.remainingStudents.length===0?"没有更多可用学生":"重新抽取此学生"},null,8,["onClick","disabled","title"])]),_:2},1024)]),_:2},1024))),128))])):a.pickingMode==="group"?(f(),w("div",ca,[(f(!0),w(F,null,O(a.pickedGroups,(d,u)=>(f(),_(N,{key:u,class:"mb-3 group-result-card",variant:"tonal"},{default:o(()=>[s(q,{class:"group-title"},{default:o(()=>[h("小组 "+k(u+1),1)]),_:2},1024),s(E,null,{default:o(()=>[(f(!0),w(F,null,O(d,i=>(f(),_(K,{key:i,class:"student-chip",label:"",size:"large"},{default:o(()=>[h(k(i),1)]),_:2},1024))),128)),d.length===0?(f(),w("div",ha,"（空）")):I("",!0)]),_:2},1024)]),_:2},1024))),128))])):I("",!0),v("div",ma,[s(b,{color:"primary","prepend-icon":"mdi-refresh",onClick:t[5]||(t[5]=d=>l.resetPicker()),size:"large",class:"mx-2"},{default:o(()=>t[12]||(t[12]=[h(" 重新抽取 ")])),_:1}),s(b,{color:"grey",variant:"outlined",onClick:t[6]||(t[6]=d=>a.dialog=!1),size:"large",class:"mx-2"},{default:o(()=>t[13]||(t[13]=[h(" 关闭 ")])),_:1})])]))]),_:1})):(f(),_(E,{key:0,class:"text-center py-6"},{default:o(()=>[s(it,{modelValue:a.pickingMode,"onUpdate:modelValue":t[1]||(t[1]=d=>a.pickingMode=d),mandatory:"",color:"primary",variant:"outlined",class:"mode-toggle"},{default:o(()=>[s(b,{value:"individual","prepend-icon":"mdi-account"},{default:o(()=>t[9]||(t[9]=[h(" 抽个人 ")])),_:1}),s(b,{value:"group","prepend-icon":"mdi-account-group"},{default:o(()=>t[10]||(t[10]=[h(" 抽小组 ")])),_:1})]),_:1},8,["modelValue"]),v("div",qt,"请选择抽取"+k(l.countLabel),1),v("div",Kt,[s(b,{size:"x-large",icon:"mdi-minus",variant:"tonal",color:"primary",disabled:(a.pickingMode==="individual"?a.count:a.numberOfGroups)<=l.minAllowedCount,onClick:l.decrementCount,class:"counter-btn"},null,8,["disabled","onClick"]),v("div",Jt,[v("span",Xt,k(a.pickingMode==="individual"?a.count:a.numberOfGroups),1),v("span",Qt,k(l.countLabel),1)]),s(b,{size:"x-large",icon:"mdi-plus",variant:"tonal",color:"primary",disabled:(a.pickingMode==="individual"?a.count:a.numberOfGroups)>=l.maxAllowedCount,onClick:l.incrementCount,class:"counter-btn"},null,8,["disabled","onClick"])]),v("div",Zt,[s(b,{size:"x-large",color:"primary","prepend-icon":"mdi-dice-multiple",onClick:l.startPicking,disabled:l.startDisabled,class:"start-btn"},{default:o(()=>t[11]||(t[11]=[h(" 开始抽取 ")])),_:1},8,["onClick","disabled"])]),l.startDisabled&&l.filteredStudents.length>0?(f(),w("div",$t,k(a.pickingMode==="group"?"学生人数不足以分成所选组数":"可抽取学生人数不足"),1)):l.filteredStudents.length===0?(f(),w("div",ea," 没有可抽取的学生，请调整过滤选项 ")):I("",!0),v("div",ta,[h(" 当前可抽取学生: "+k(l.filteredStudents.length)+"人 ",1),s(He,{location:"bottom"},{activator:o(({props:d})=>[s(Y,j(d,{icon:"mdi-information-outline",size:"small",class:"ml-1"}),null,16)]),default:o(()=>[v("div",aa,[a.tempFilters.excludeAbsent?(f(),w("div",na,"• 已排除请假学生 ("+k(l.absentCount)+"人)",1)):I("",!0),a.tempFilters.excludeLate?(f(),w("div",sa,"• 已排除迟到学生 ("+k(l.lateCount)+"人)",1)):I("",!0),a.tempFilters.excludeExcluded?(f(),w("div",ia,"• 已排除不参与学生 ("+k(l.excludedCount)+"人)",1)):I("",!0)])]),_:1}),v("div",la,[s(K,{color:a.tempFilters.excludeLate?"warning":"default",variant:a.tempFilters.excludeLate?"elevated":"text",onClick:t[2]||(t[2]=d=>a.tempFilters.excludeLate=!a.tempFilters.excludeLate),"prepend-icon":"mdi-clock-alert",class:"filter-chip"},{default:o(()=>[h(k(a.tempFilters.excludeLate?"排除":"包含")+"迟到学生 ",1)]),_:1},8,["color","variant"]),s(K,{color:a.tempFilters.excludeAbsent?"error":"default",variant:a.tempFilters.excludeAbsent?"elevated":"text",onClick:t[3]||(t[3]=d=>a.tempFilters.excludeAbsent=!a.tempFilters.excludeAbsent),"prepend-icon":"mdi-account-off",class:"filter-chip"},{default:o(()=>[h(k(a.tempFilters.excludeAbsent?"排除":"包含")+"请假学生 ",1)]),_:1},8,["color","variant"]),s(K,{color:a.tempFilters.excludeExcluded?"grey":"default",variant:a.tempFilters.excludeExcluded?"elevated":"text",onClick:t[4]||(t[4]=d=>a.tempFilters.excludeExcluded=!a.tempFilters.excludeExcluded),"prepend-icon":"mdi-account-cancel",class:"filter-chip"},{default:o(()=>[h(k(a.tempFilters.excludeExcluded?"排除":"包含")+"不参与学生 ",1)]),_:1},8,["color","variant"])])])]),_:1}))]),_:1})]),_:1},8,["modelValue"])}const va=Be(Wt,[["render",fa],["__scopeId","data-v-8126bf3a"]]);function ga(e,t){let n=null;return function(...r){n&&clearTimeout(n),n=setTimeout(()=>{e.apply(this,r)},t)}}function ka(e,t){let n=null,r=0;return function(...a){const l=Date.now();l-r<t?(n&&clearTimeout(n),n=setTimeout(()=>{r=l,e.apply(this,a)},t)):(r=l,e.apply(this,a))}}const pa=R({...rt({icon:"$menu",variant:"text"})},"VAppBarNavIcon"),ya=H()({name:"VAppBarNavIcon",props:pa(),setup(e,t){let{slots:n}=t;return W(()=>s(b,j(e,{class:["v-app-bar-nav-icon"]}),n)),{}}}),We=R({active:{type:[String,Array],default:void 0},controlHeight:[Number,String],disabled:{type:[Boolean,String,Array],default:null},nextIcon:{type:de,default:"$next"},prevIcon:{type:de,default:"$prev"},modeIcon:{type:de,default:"$subgroup"},text:String,viewMode:{type:String,default:"month"}},"VDatePickerControls"),Fe=H()({name:"VDatePickerControls",props:We(),emits:{"click:year":()=>!0,"click:month":()=>!0,"click:prev":()=>!0,"click:next":()=>!0,"click:text":()=>!0},setup(e,t){let{emit:n}=t;const r=V(()=>Array.isArray(e.disabled)?e.disabled.includes("text"):!!e.disabled),a=V(()=>Array.isArray(e.disabled)?e.disabled.includes("mode"):!!e.disabled),l=V(()=>Array.isArray(e.disabled)?e.disabled.includes("prev"):!!e.disabled),d=V(()=>Array.isArray(e.disabled)?e.disabled.includes("next"):!!e.disabled);function u(){n("click:prev")}function i(){n("click:next")}function c(){n("click:year")}function g(){n("click:month")}return W(()=>s("div",{class:["v-date-picker-controls"],style:{"--v-date-picker-controls-height":ye(e.controlHeight)}},[s(b,{class:"v-date-picker-controls__month-btn","data-testid":"month-btn",disabled:r.value,text:e.text,variant:"text",rounded:!0,onClick:g},null),s(b,{class:"v-date-picker-controls__mode-btn","data-testid":"year-btn",disabled:a.value,density:"comfortable",icon:e.modeIcon,variant:"text",onClick:c},null),s(Q,null,null),s("div",{class:"v-date-picker-controls__month"},[s(b,{"data-testid":"prev-month",disabled:l.value,density:"comfortable",icon:e.prevIcon,variant:"text",onClick:u},null),s(b,{"data-testid":"next-month",disabled:d.value,icon:e.nextIcon,density:"comfortable",variant:"text",onClick:i},null)])])),{}}}),ba=R({appendIcon:de,color:String,header:String,transition:String,onClick:ot()},"VDatePickerHeader"),Te=H()({name:"VDatePickerHeader",props:ba(),emits:{click:()=>!0,"click:append":()=>!0},setup(e,t){let{emit:n,slots:r}=t;const{backgroundColorClasses:a,backgroundColorStyles:l}=be(e,"color");function d(){n("click")}function u(){n("click:append")}return W(()=>{const i=!!(r.default||e.header),c=!!(r.append||e.appendIcon);return s("div",{class:["v-date-picker-header",{"v-date-picker-header--clickable":!!e.onClick},a.value],style:l.value,onClick:d},[r.prepend&&s("div",{key:"prepend",class:"v-date-picker-header__prepend"},[r.prepend()]),i&&s(ze,{key:"content",name:e.transition},{default:()=>{var g;return[s("div",{key:e.header,class:"v-date-picker-header__content"},[((g=r.default)==null?void 0:g.call(r))??e.header])]}}),c&&s("div",{class:"v-date-picker-header__append"},[r.append?s(xe,{key:"append-defaults",disabled:!e.appendIcon,defaults:{VBtn:{icon:e.appendIcon,variant:"text"}}},{default:()=>{var g;return[(g=r.append)==null?void 0:g.call(r)]}}):s(b,{key:"append-btn",icon:e.appendIcon,variant:"text",onClick:u},null)])])}),{}}}),xa=R({allowedDates:[Array,Function],disabled:{type:Boolean,default:null},displayValue:null,modelValue:Array,month:[Number,String],max:null,min:null,showAdjacentMonths:Boolean,year:[Number,String],weekdays:{type:Array,default:()=>[0,1,2,3,4,5,6]},weeksInMonth:{type:String,default:"dynamic"},firstDayOfWeek:{type:[Number,String],default:void 0}},"calendar");function Sa(e){const t=le(),n=J(e,"modelValue",[],m=>ue(m).map(p=>t.date(p))),r=V(()=>e.displayValue?t.date(e.displayValue):n.value.length>0?t.date(n.value[0]):e.min?t.date(e.min):Array.isArray(e.allowedDates)?t.date(e.allowedDates[0]):t.date()),a=J(e,"year",void 0,m=>{const p=m!=null?Number(m):t.getYear(r.value);return t.startOfYear(t.setYear(t.date(),p))},m=>t.getYear(m)),l=J(e,"month",void 0,m=>{const p=m!=null?Number(m):t.getMonth(r.value),D=t.setYear(t.startOfMonth(t.date()),t.getYear(a.value));return t.setMonth(D,p)},m=>t.getMonth(m)),d=V(()=>{const m=t.toJsDate(t.startOfWeek(t.date(),e.firstDayOfWeek)).getDay();return[0,1,2,3,4,5,6].map(p=>(p+m)%7)}),u=V(()=>{const m=t.getWeekArray(l.value,e.firstDayOfWeek),p=m.flat(),D=6*7;if(e.weeksInMonth==="static"&&p.length<D){const T=p[p.length-1];let P=[];for(let x=1;x<=D-p.length;x++)P.push(t.addDays(T,x)),x%7===0&&(m.push(P),P=[])}return m});function i(m,p){return m.filter(D=>d.value.includes(t.toJsDate(D).getDay())).map((D,T)=>{const P=t.toISO(D),x=!t.isSameMonth(D,l.value),B=t.isSameDay(D,t.startOfMonth(l.value)),U=t.isSameDay(D,t.endOfMonth(l.value)),G=t.isSameDay(D,l.value);return{date:D,isoDate:P,formatted:t.format(D,"keyboardDate"),year:t.getYear(D),month:t.getMonth(D),isDisabled:L(D),isWeekStart:T%7===0,isWeekEnd:T%7===6,isToday:t.isSameDay(D,p),isAdjacent:x,isHidden:x&&!e.showAdjacentMonths,isStart:B,isSelected:n.value.some(ee=>t.isSameDay(D,ee)),isEnd:U,isSame:G,localized:t.format(D,"dayOfMonth")}})}const c=V(()=>{const m=t.startOfWeek(r.value,e.firstDayOfWeek),p=[];for(let T=0;T<=6;T++)p.push(t.addDays(m,T));const D=t.date();return i(p,D)}),g=V(()=>{const m=u.value.flat(),p=t.date();return i(m,p)}),C=V(()=>u.value.map(m=>m.length?t.getWeek(m[0],e.firstDayOfWeek):null));function L(m){if(e.disabled)return!0;const p=t.date(m);return e.min&&t.isAfter(t.date(e.min),p)||e.max&&t.isAfter(p,t.date(e.max))?!0:Array.isArray(e.allowedDates)&&e.allowedDates.length>0?!e.allowedDates.some(D=>t.isSameDay(t.date(D),p)):typeof e.allowedDates=="function"?!e.allowedDates(p):!e.weekdays.includes(t.toJsDate(p).getDay())}return{displayValue:r,daysInMonth:g,daysInWeek:c,genDays:i,model:n,weeksInMonth:u,weekDays:d,weekNumbers:C}}const qe=R({color:String,hideWeekdays:Boolean,multiple:[Boolean,Number,String],showWeek:Boolean,transition:{type:String,default:"picker-transition"},reverseTransition:{type:String,default:"picker-reverse-transition"},...$(xa(),["displayValue"])},"VDatePickerMonth"),Oe=H()({name:"VDatePickerMonth",props:qe(),emits:{"update:modelValue":e=>!0,"update:month":e=>!0,"update:year":e=>!0},setup(e,t){let{emit:n,slots:r}=t;const a=he(),{daysInMonth:l,model:d,weekNumbers:u}=Sa(e),i=le(),c=ce(),g=ce(),C=ce(!1),L=V(()=>C.value?e.reverseTransition:e.transition);e.multiple==="range"&&d.value.length>0&&(c.value=d.value[0],d.value.length>1&&(g.value=d.value[d.value.length-1]));const m=V(()=>{const P=["number","string"].includes(typeof e.multiple)?Number(e.multiple):1/0;return d.value.length>=P});Re(l,(P,x)=>{x&&(C.value=i.isBefore(P[0].date,x[0].date))});function p(P){const x=i.startOfDay(P);if(d.value.length===0?c.value=void 0:d.value.length===1&&(c.value=d.value[0],g.value=void 0),!c.value)c.value=x,d.value=[c.value];else if(g.value)c.value=P,g.value=void 0,d.value=[c.value];else{if(i.isSameDay(x,c.value)){c.value=void 0,d.value=[];return}else i.isBefore(x,c.value)?(g.value=i.endOfDay(c.value),c.value=x):g.value=i.endOfDay(x);const B=i.getDiff(g.value,c.value,"days"),U=[c.value];for(let G=1;G<B;G++){const ee=i.addDays(c.value,G);U.push(ee)}U.push(g.value),d.value=U}}function D(P){const x=d.value.findIndex(B=>i.isSameDay(B,P));if(x===-1)d.value=[...d.value,P];else{const B=[...d.value];B.splice(x,1),d.value=B}}function T(P){e.multiple==="range"?p(P):e.multiple?D(P):d.value=[P]}W(()=>s("div",{class:"v-date-picker-month"},[e.showWeek&&s("div",{key:"weeks",class:"v-date-picker-month__weeks"},[!e.hideWeekdays&&s("div",{key:"hide-week-days",class:"v-date-picker-month__day"},[h(" ")]),u.value.map(P=>s("div",{class:["v-date-picker-month__day","v-date-picker-month__day--adjacent"]},[P]))]),s(ze,{name:L.value},{default:()=>{var P;return[s("div",{ref:a,key:(P=l.value[0].date)==null?void 0:P.toString(),class:"v-date-picker-month__days"},[!e.hideWeekdays&&i.getWeekdays(e.firstDayOfWeek).map(x=>s("div",{class:["v-date-picker-month__day","v-date-picker-month__weekday"]},[x])),l.value.map((x,B)=>{var G;const U={props:{class:"v-date-picker-month__day-btn",color:x.isSelected||x.isToday?e.color:void 0,disabled:x.isDisabled,icon:!0,ripple:!1,text:x.localized,variant:x.isSelected?"flat":x.isToday?"outlined":"text",onClick:()=>T(x.date)},item:x,i:B};return m.value&&!x.isSelected&&(x.isDisabled=!0),s("div",{class:["v-date-picker-month__day",{"v-date-picker-month__day--adjacent":x.isAdjacent,"v-date-picker-month__day--hide-adjacent":x.isHidden,"v-date-picker-month__day--selected":x.isSelected,"v-date-picker-month__day--week-end":x.isWeekEnd,"v-date-picker-month__day--week-start":x.isWeekStart}],"data-v-date":x.isDisabled?void 0:x.isoDate},[(e.showAdjacentMonths||!x.isAdjacent)&&(((G=r.day)==null?void 0:G.call(r,U))??s(b,U.props,null))])})])]}})]))}}),Ke=R({color:String,height:[String,Number],min:null,max:null,modelValue:Number,year:Number},"VDatePickerMonths"),je=H()({name:"VDatePickerMonths",props:Ke(),emits:{"update:modelValue":e=>!0},setup(e,t){let{emit:n,slots:r}=t;const a=le(),l=J(e,"modelValue"),d=V(()=>{let u=a.startOfYear(a.date());return e.year&&(u=a.setYear(u,e.year)),Ue(12).map(i=>{const c=a.format(u,"monthShort"),g=!!(e.min&&a.isAfter(a.startOfMonth(a.date(e.min)),u)||e.max&&a.isAfter(u,a.startOfMonth(a.date(e.max))));return u=a.getNextMonth(u),{isDisabled:g,text:c,value:i}})});return Ge(()=>{l.value=l.value??a.getMonth(a.date())}),W(()=>s("div",{class:"v-date-picker-months",style:{height:ye(e.height)}},[s("div",{class:"v-date-picker-months__content"},[d.value.map((u,i)=>{var C;const c={active:l.value===i,color:l.value===i?e.color:void 0,disabled:u.isDisabled,rounded:!0,text:u.text,variant:l.value===u.value?"flat":"text",onClick:()=>g(i)};function g(L){if(l.value===L){n("update:modelValue",l.value);return}l.value=L}return((C=r.month)==null?void 0:C.call(r,{month:u,i,props:c}))??s(b,j({key:"month"},c),null)})])])),{}}}),Je=R({color:String,height:[String,Number],min:null,max:null,modelValue:Number},"VDatePickerYears"),Ne=H()({name:"VDatePickerYears",props:Je(),emits:{"update:modelValue":e=>!0},setup(e,t){let{emit:n,slots:r}=t;const a=le(),l=J(e,"modelValue"),d=V(()=>{const i=a.getYear(a.date());let c=i-100,g=i+52;e.min&&(c=a.getYear(a.date(e.min))),e.max&&(g=a.getYear(a.date(e.max)));let C=a.startOfYear(a.date());return C=a.setYear(C,c),Ue(g-c+1,c).map(L=>{const m=a.format(C,"year");return C=a.setYear(C,a.getYear(C)+1),{text:m,value:L}})});Ge(()=>{l.value=l.value??a.getYear(a.date())});const u=dt();return ut(async()=>{var i;await ct(),(i=u.el)==null||i.scrollIntoView({block:"center"})}),W(()=>s("div",{class:"v-date-picker-years",style:{height:ye(e.height)}},[s("div",{class:"v-date-picker-years__content"},[d.value.map((i,c)=>{var C;const g={ref:l.value===i.value?u:void 0,active:l.value===i.value,color:l.value===i.value?e.color:void 0,rounded:!0,text:i.text,variant:l.value===i.value?"flat":"text",onClick:()=>{if(l.value===i.value){n("update:modelValue",l.value);return}l.value=i.value}};return((C=r.year)==null?void 0:C.call(r,{year:i,i:c,props:g}))??s(b,j({key:"month"},g),null)})])])),{}}}),Da=Ot("v-picker-title"),Xe=R({color:String,...Pt(),...Vt(),...Ct(),...wt(),...Dt(),...St(),...xt(),...bt(),...yt()},"VSheet"),Ee=H()({name:"VSheet",props:Xe(),setup(e,t){let{slots:n}=t;const{themeClasses:r}=ht(e),{backgroundColorClasses:a,backgroundColorStyles:l}=be(Ye(e,"color")),{borderClasses:d}=mt(e),{dimensionStyles:u}=ft(e),{elevationClasses:i}=vt(e),{locationStyles:c}=gt(e),{positionClasses:g}=kt(e),{roundedClasses:C}=pt(e);return W(()=>s(e.tag,{class:["v-sheet",r.value,a.value,d.value,i.value,g.value,C.value,e.class],style:[l.value,u.value,c.value,e.style]},n)),{}}}),Qe=R({bgColor:String,divided:Boolean,landscape:Boolean,title:String,hideHeader:Boolean,...Xe()},"VPicker"),Ie=H()({name:"VPicker",props:Qe(),setup(e,t){let{slots:n}=t;const{backgroundColorClasses:r,backgroundColorStyles:a}=be(Ye(e,"color"));return W(()=>{const l=Ee.filterProps(e),d=!!(e.title||n.title);return s(Ee,j(l,{color:e.bgColor,class:["v-picker",{"v-picker--divided":e.divided,"v-picker--landscape":e.landscape,"v-picker--with-actions":!!n.actions},e.class],style:e.style}),{default:()=>{var u;return[!e.hideHeader&&s("div",{key:"header",class:[r.value],style:[a.value]},[d&&s(Da,{key:"picker-title"},{default:()=>{var i;return[((i=n.title)==null?void 0:i.call(n))??e.title]}}),n.header&&s("div",{class:"v-picker__header"},[n.header()])]),s("div",{class:"v-picker__body"},[(u=n.default)==null?void 0:u.call(n)]),n.actions&&s(xe,{defaults:{VBtn:{slim:!0,variant:"text"}}},{default:()=>[s("div",{class:"v-picker__actions"},[n.actions()])]})]}})}),{}}}),wa=R({header:{type:String,default:"$vuetify.datePicker.header"},headerColor:String,...We(),...qe({weeksInMonth:"static"}),...$(Ke(),["modelValue"]),...$(Je(),["modelValue"]),...Qe({title:"$vuetify.datePicker.title"}),modelValue:null},"VDatePicker"),Ca=H()({name:"VDatePicker",props:wa(),emits:{"update:modelValue":e=>!0,"update:month":e=>!0,"update:year":e=>!0,"update:viewMode":e=>!0},setup(e,t){let{emit:n,slots:r}=t;const a=le(),{t:l}=At(),{rtlClasses:d}=_t(),u=J(e,"modelValue",void 0,S=>ue(S).map(A=>a.date(A)),S=>e.multiple?S:S[0]),i=J(e,"viewMode"),c=V(()=>{const S=a.date(e.min);return e.min&&a.isValid(S)?S:null}),g=V(()=>{const S=a.date(e.max);return e.max&&a.isValid(S)?S:null}),C=V(()=>{var z;const S=a.date();let A=S;return(z=u.value)!=null&&z[0]?A=a.date(u.value[0]):c.value&&a.isBefore(S,c.value)?A=c.value:g.value&&a.isAfter(S,g.value)&&(A=g.value),A&&a.isValid(A)?A:S}),L=V(()=>e.headerColor??e.color),m=he(Number(e.month??a.getMonth(a.startOfMonth(C.value)))),p=he(Number(e.year??a.getYear(a.startOfYear(a.setMonth(C.value,m.value))))),D=ce(!1),T=V(()=>e.multiple&&u.value.length>1?l("$vuetify.datePicker.itemsSelected",u.value.length):u.value[0]&&a.isValid(u.value[0])?a.format(a.date(u.value[0]),"normalDateWithWeekday"):l(e.header)),P=V(()=>{let S=a.date();return S=a.setDate(S,1),S=a.setMonth(S,m.value),S=a.setYear(S,p.value),a.format(S,"monthAndYear")}),x=V(()=>`date-picker-header${D.value?"-reverse":""}-transition`),B=V(()=>{if(e.disabled)return!0;const S=[];if(i.value!=="month")S.push("prev","next");else{let A=a.date();if(A=a.startOfMonth(A),A=a.setMonth(A,m.value),A=a.setYear(A,p.value),c.value){const z=a.addDays(a.startOfMonth(A),-1);a.isAfter(c.value,z)&&S.push("prev")}if(g.value){const z=a.addDays(a.endOfMonth(A),1);a.isAfter(z,g.value)&&S.push("next")}}return S});function U(){m.value<11?m.value++:(p.value++,m.value=0,ae(p.value)),te(m.value)}function G(){m.value>0?m.value--:(p.value--,m.value=11,ae(p.value)),te(m.value)}function ee(){i.value="month"}function Se(){i.value=i.value==="months"?"month":"months"}function De(){i.value=i.value==="year"?"month":"year"}function te(S){i.value==="months"&&Se(),n("update:month",S)}function ae(S){i.value==="year"&&De(),n("update:year",S)}return Re(u,(S,A)=>{const z=ue(A),ne=ue(S);if(!ne.length)return;const me=a.date(z[z.length-1]),se=a.date(ne[ne.length-1]),Z=a.getMonth(se),M=a.getYear(se);Z!==m.value&&(m.value=Z,te(m.value)),M!==p.value&&(p.value=M,ae(p.value)),D.value=a.isBefore(me,se)}),W(()=>{const S=Ie.filterProps(e),A=Fe.filterProps(e),z=Te.filterProps(e),ne=Oe.filterProps(e),me=$(je.filterProps(e),["modelValue"]),se=$(Ne.filterProps(e),["modelValue"]),Z={color:L.value,header:T.value,transition:x.value};return s(Ie,j(S,{color:L.value,class:["v-date-picker",`v-date-picker--${i.value}`,{"v-date-picker--show-week":e.showWeek},d.value,e.class],style:e.style}),{title:()=>{var M;return((M=r.title)==null?void 0:M.call(r))??s("div",{class:"v-date-picker__title"},[l(e.title)])},header:()=>r.header?s(xe,{defaults:{VDatePickerHeader:{...Z}}},{default:()=>{var M;return[(M=r.header)==null?void 0:M.call(r,Z)]}}):s(Te,j({key:"header"},z,Z,{onClick:i.value!=="month"?ee:void 0}),{...r,default:void 0}),default:()=>s(F,null,[s(Fe,j(A,{disabled:B.value,text:P.value,"onClick:next":U,"onClick:prev":G,"onClick:month":Se,"onClick:year":De}),null),s(It,{hideOnLeave:!0},{default:()=>[i.value==="months"?s(je,j({key:"date-picker-months"},me,{modelValue:m.value,"onUpdate:modelValue":[M=>m.value=M,te],min:c.value,max:g.value,year:p.value}),null):i.value==="year"?s(Ne,j({key:"date-picker-years"},se,{modelValue:p.value,"onUpdate:modelValue":[M=>p.value=M,ae],min:c.value,max:g.value}),null):s(Oe,j({key:"date-picker-month"},ne,{modelValue:u.value,"onUpdate:modelValue":M=>u.value=M,month:m.value,"onUpdate:month":[M=>m.value=M,te],year:p.value,"onUpdate:year":[M=>p.value=M,ae],min:c.value,max:g.value}),null)]})]),actions:r.actions})}),{}}}),Va={name:"Classworks 作业板",components:{MessageLog:Ze,RandomPicker:va},data(){return{dataKey:"",provider:"",useDisplay:_e,state:{classNumber:"",studentList:[],boardData:{homework:{},attendance:{absent:[],late:[],exclude:[]}},dialogVisible:!1,dialogTitle:"",textarea:"",dateString:"",synced:!1,attendDialogVisible:!1,contentStyle:{"font-size":`${y("font.size")}px`},uploadLoading:!1,downloadLoading:!1,snackbar:!1,snackbarText:"",fontSize:y("font.size"),datePickerDialog:!1,selectedDate:new Date().toISOString().split("T")[0],selectedDateObj:new Date(this.selectedDate),refreshInterval:null,subjectOrder:["语文","数学","英语","物理","化学","生物","政治","历史","地理","其他"],showNoDataMessage:!1,noDataMessage:"",isToday:!1,attendanceDialog:!1,isFullscreen:!1},loading:{download:!1,upload:!1,students:!1},debouncedUpload:null,throttledReflow:null,sortedItemsCache:{key:"",value:[]},confirmDialog:{show:!1,resolve:null,reject:null},attendanceSearch:"",attendanceFilter:[],urlConfigDialog:{show:!1,config:null,changes:[],validSettings:{},confirmHandler:null,cancelHandler:null,icons:{}}}},computed:{...Lt(Ce,["subjects"]),availableSubjects(){const e=Array.isArray(this.subjects)?this.subjects:[];console.log("[index.vue] Store subjects in computed:",e);const t=e.map(n=>({key:n,name:n}));return console.log("[index.vue] Computed availableSubjects:",t),t},isMobile(){return _e().mobile.value},titleText(){const e=this.getToday(),t=new Date(e);t.setDate(t.getDate()-1);const n=this.state.dateString,r=this.formatDate(e),a=this.formatDate(t);return n===r?"今天的作业":n===a?"昨天的作业":`${n}的作业`},sortedItems(){const e=`${JSON.stringify(this.state.boardData.homework)}_${this.state.subjectOrder.join()}_${this.dynamicSort}`;if(this.sortedItemsCache.key===e)return this.sortedItemsCache.value;const t=Object.entries(this.state.boardData.homework).filter(([,r])=>{var a;return(a=r.content)==null?void 0:a.trim()}).map(([r,a])=>{var l;return{key:r,name:((l=this.availableSubjects.find(d=>d.key===r))==null?void 0:l.name)||r,content:a.content,order:this.state.subjectOrder.indexOf(r),rowSpan:Math.ceil((a.content.split(`
`).filter(d=>d.trim()).length+1)*.8)}});console.log("[index.vue] Calculating sortedItems. Homework data:",this.state.boardData.homework),console.log("[index.vue] Calculating sortedItems. Available subjects:",this.availableSubjects);const n=this.dynamicSort?this.optimizeGridLayout(t):t.sort((r,a)=>r.order-a.order);return this.updateSortedItemsCache(e,n),console.log("[index.vue] Computed sortedItems:",n),n},unusedSubjects(){const e=Object.keys(this.state.boardData.homework).filter(n=>{var r;return(r=this.state.boardData.homework[n].content)==null?void 0:r.trim()});console.log("[index.vue] Calculating unusedSubjects. Used keys:",e),console.log("[index.vue] Calculating unusedSubjects. Available subjects:",this.availableSubjects);const t=this.availableSubjects.filter(n=>!e.includes(n.key));return console.log("[index.vue] Computed unusedSubjects:",t),t},emptySubjects(){return this.emptySubjectDisplay!=="button"?[]:this.unusedSubjects},autoSave(){return y("edit.autoSave")},blockNonTodayAutoSave(){return y("edit.blockNonTodayAutoSave")},isToday(){const e=new Date().toISOString().split("T")[0];return this.state.dateString===e},canAutoSave(){return this.autoSave&&(!this.blockNonTodayAutoSave||this.isToday)},needConfirmSave(){return!this.isToday&&this.confirmNonTodaySave},shouldShowBlockedMessage(){return!this.isToday&&this.autoSave&&this.blockNonTodayAutoSave},refreshBeforeEdit(){return y("edit.refreshBeforeEdit")},emptySubjectDisplay(){return y("display.emptySubjectDisplay")},dynamicSort(){return y("display.dynamicSort")},isEditingDisabled(){return this.state.uploadLoading||this.state.downloadLoading},unreadCount(){var e;return((e=this.$refs.messageLog)==null?void 0:e.unreadCount)||0},showRandomPickerButton(){return y("randomPicker.enabled")},confirmNonTodaySave(){return y("edit.confirmNonTodaySave")},shouldShowSaveConfirm(){return!this.isToday&&this.confirmNonTodaySave},shouldBlockAutoSave(){return!this.isToday&&this.autoSave&&this.blockNonTodayAutoSave},showFullscreenButton(){return y("display.showFullscreenButton")},showAntiScreenBurnCard(){return y("display.showAntiScreenBurnCard")},filteredStudents(){let e=[...this.state.studentList];if(this.attendanceSearch){const t=this.attendanceSearch.toLowerCase();e=e.filter(n=>n.toLowerCase().includes(t))}return this.attendanceFilter&&this.attendanceFilter.length>0&&(e=e.filter(t=>{const n=this.state.studentList.indexOf(t);return!!(this.attendanceFilter.includes("present")&&this.isPresent(n)||this.attendanceFilter.includes("absent")&&this.isAbsent(n)||this.attendanceFilter.includes("late")&&this.isLate(n)||this.attendanceFilter.includes("exclude")&&this.isExclude(n))})),e},extractedSurnames(){if(!this.state.studentList||this.state.studentList.length===0)return[];const e=new Map;return this.state.studentList.forEach(t=>{if(t&&t.length>0){const n=t.charAt(0);e.has(n)?e.set(n,e.get(n)+1):e.set(n,1)}}),Array.from(e.entries()).map(([t,n])=>({name:t,count:n})).sort((t,n)=>{const r=we(t.name,{toneType:"none",mode:"surname"}),a=we(n.name,{toneType:"none",mode:"surname"});return r.localeCompare(a)})}},watch:{homeworkData:{handler(){this.$nextTick(()=>{this.$refs.waterfall&&this.$refs.waterfall.reflow()})},deep:!0},"$vuetify.display.width":{handler(){this.throttledReflow()},deep:!0}},created(){this.debouncedUpload=ga(this.uploadData,2e3),this.throttledReflow=ka(()=>{this.$refs.gridContainer&&this.optimizeGridLayout(this.sortedItems)},200)},async mounted(){try{const e=y("subjects");console.log("[index.vue mounted] Subjects from settings:",e);const t=Array.isArray(e)?e:[];if(e==null){console.log("[index.vue mounted] No subjects setting found or it is null/undefined, adding default subjects");const n=["语文","数学","英语","物理","化学","生物","政治","历史","地理","其他"];re("subjects",n),this.setSubjects(n)}else{const n=Array.isArray(e)?e:[];this.setSubjects(n),console.log("[index.vue mounted] Updated Pinia store with subjects from settings:",n)}this.updateBackendUrl(),await this.initializeData(),this.setupAutoRefresh(),this.unwatchSettings=Tt(()=>{this.updateSettings()}),document.addEventListener("fullscreenchange",this.fullscreenChangeHandler),document.addEventListener("webkitfullscreenchange",this.fullscreenChangeHandler),document.addEventListener("mozfullscreenchange",this.fullscreenChangeHandler),document.addEventListener("MSFullscreenChange",this.fullscreenChangeHandler),this.checkHashForRandomPicker(),window.addEventListener("hashchange",this.checkHashForRandomPicker)}catch(e){console.error("初始化失败:",e),this.showError("初始化失败，请刷新页面重试")}},beforeUnmount(){this.unwatchSettings&&this.unwatchSettings(),this.state.refreshInterval&&clearInterval(this.state.refreshInterval),document.removeEventListener("fullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("webkitfullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("mozfullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("MSFullscreenChange",this.fullscreenChangeHandler),window.removeEventListener("hashchange",this.checkHashForRandomPicker)},methods:{...Mt(Ce,["setSubjects"]),ensureDate(e){if(e instanceof Date)return e;if(typeof e=="string"){const t=new Date(e);if(!isNaN(t.getTime()))return t}return new Date},formatDate(e){const t=this.ensureDate(e),n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${n}-${r}-${a}`},getToday(){return new Date},async initializeData(){if(!await this.parseUrlConfig()){this.provider=y("server.provider");const l=y("server.domain"),d=y("server.classNumber");this.dataKey=this.provider==="server"?`${l}/${d}`:d,this.state.classNumber=d}const n=new URLSearchParams(window.location.search).get("date"),r=this.getToday(),a=n?new Date(n):r;this.state.dateString=this.formatDate(a),this.state.selectedDate=this.state.dateString,this.state.isToday=this.formatDate(a)===this.formatDate(r),await Promise.all([this.downloadData(),this.loadConfig()])},async downloadData(){var e,t,n;if(!this.loading.download)try{this.loading.download=!0;const r=await fe.loadData(this.provider,this.dataKey,this.state.dateString);if(r.success)this.state.boardData={homework:r.data.homework||{},attendance:{absent:((e=r.data.attendance)==null?void 0:e.absent)||[],late:((t=r.data.attendance)==null?void 0:t.late)||[],exclude:((n=r.data.attendance)==null?void 0:n.exclude)||[]}},this.state.synced=!0,this.state.showNoDataMessage=!1,this.$message.success("下载成功","数据已更新");else if(r.error.code==="NOT_FOUND")this.state.showNoDataMessage=!0,this.state.noDataMessage=r.error.message,this.state.boardData={homework:{},attendance:{absent:[],late:[],exclude:[]}};else throw new Error(r.error.message)}catch(r){this.state.boardData={homework:{},attendance:{absent:[],late:[],exclude:[]}},this.$message.error("下载失败",r.message)}finally{this.loading.download=!1}},async trySave(e=!1){if(e&&!this.canAutoSave)return this.shouldShowBlockedMessage&&this.showMessage("需要手动保存","已禁止自动保存非当天数据","warning"),!1;if(!e&&this.needConfirmSave)try{await this.showConfirmDialog()}catch{return!1}try{return await this.uploadData(),!0}catch(t){return this.$message.error("保存失败",t.message||"请重试"),!1}},async handleClose(){var n;if(!this.currentEditSubject)return;const e=this.state.textarea.trim(),t=((n=this.state.boardData.homework[this.currentEditSubject])==null?void 0:n.content)||"";e!==t.trim()&&(this.state.boardData.homework[this.currentEditSubject]={content:e},this.state.synced=!1,this.autoSave&&await this.trySave(!0)),this.state.dialogVisible=!1},async uploadData(){if(!this.loading.upload)try{this.loading.upload=!0;const e=await fe.saveData(this.provider,this.dataKey,this.state.boardData,this.state.dateString);if(!e.success)throw new Error(e.error.message);this.state.synced=!0,this.$message.success(e.message||"保存成功")}finally{this.loading.upload=!1}},async loadConfig(){try{const e=await fe.loadConfig(this.provider,this.dataKey);if(!e.success)throw new Error(e.error.message);this.state.studentList=e.data.studentList||[]}catch(e){console.error("加载配置失败:",e),this.$message.error("加载配置失败",e.message)}},showSyncMessage(){this.$message.success("数据已同步","数据已完成与服务器同步")},async openDialog(e){var t;if(this.refreshBeforeEdit)try{await this.downloadData()}catch(n){console.error("刷新数据失败:",n),this.$message.error("刷新数据失败，可能显示的不是最新数据")}this.currentEditSubject=e,this.state.boardData.homework[e]||(this.state.boardData.homework[e]={content:""}),this.state.dialogTitle=((t=this.availableSubjects.find(n=>n.key===e))==null?void 0:t.name)||e,this.state.textarea=this.state.boardData.homework[e].content,this.state.dialogVisible=!0,this.$nextTick(()=>{this.$refs.inputRef&&this.$refs.inputRef.focus()})},splitPoint(e){return e.split(`
`).filter(t=>t.trim())},setAttendanceArea(){this.state.attendanceDialog=!0},toggleStudentStatus(e){const t=this.state.studentList[e];this.state.boardData.attendance.absent.includes(t)?(this.state.boardData.attendance.absent=this.state.boardData.attendance.absent.filter(n=>n!==t),this.state.boardData.attendance.late.push(t)):this.state.boardData.attendance.late.includes(t)?(this.state.boardData.attendance.late=this.state.boardData.attendance.late.filter(n=>n!==t),this.state.boardData.attendance.exclude.push(t)):this.state.boardData.attendance.exclude.includes(t)?this.state.boardData.attendance.exclude=this.state.boardData.attendance.exclude.filter(n=>n!==t):this.state.boardData.attendance.absent.push(t),this.state.synced=!1,this.canAutoSave&&this.uploadData()},cleanstudentslist(){this.state.boardData.attendance.absent=[],this.state.boardData.attendance.late=[],this.state.boardData.attendance.exclude=[],this.state.synced=!1,this.canAutoSave&&this.uploadData()},zoom(e){e==="up"&&this.state.fontSize<100?this.state.fontSize+=2:e==="out"&&this.state.fontSize>16&&(this.state.fontSize-=2),this.state.contentStyle={"font-size":`${this.state.fontSize}px`},re("font.size",this.state.fontSize)},updateBackendUrl(){const e=y("server.provider"),t=y("server.domain"),n=y("server.classNumber");this.provider=e,this.dataKey=e==="server"?`${t}/${n}`:n,this.state.classNumber=n},setupAutoRefresh(){const e=y("refresh.auto"),t=y("refresh.interval");this.state.refreshInterval&&clearInterval(this.state.refreshInterval),e&&(this.state.refreshInterval=setInterval(()=>{this.shouldSkipRefresh()||this.downloadData()},t*1e3))},shouldSkipRefresh(){return!!(this.state.dialogVisible||this.state.attendanceDialog||this.confirmDialog.show||this.state.datePickerDialog||this.loading.upload||this.loading.download||!this.state.synced)},updateSettings(){this.state.fontSize=y("font.size"),this.state.contentStyle={"font-size":`${this.state.fontSize}px`},this.setupAutoRefresh(),this.updateBackendUrl()},handleDateSelect(e){if(e)try{const t=this.ensureDate(e),n=this.formatDate(t);this.state.dateString!==n&&(this.state.dateString=n,this.state.selectedDate=n,this.state.isToday=n===this.formatDate(this.getToday()),this.$router.replace({query:{date:n}}).catch(()=>{}),this.downloadData())}catch(t){console.error("Date processing error:",t),this.$message.error("日期处理错误","请重新选择日期")}},optimizeGridLayout(e){const t=Math.min(3,Math.floor(window.innerWidth/300));if(t<=1)return e;const n=Array.from({length:t},()=>({height:0,items:[]}));return e.forEach(r=>{const a=n.reduce((l,d,u)=>d.height<n[l].height?u:l,0);n[a].items.push(r),n[a].height+=r.rowSpan}),n.flatMap(r=>r.items).map((r,a)=>({...r,order:a}))},fixedGridLayout(e){const t=[["语文","数学","英语"],["物理","化学","生物"],["政治","历史","地理","其他"]];return e.sort((n,r)=>{const a=g=>{for(let C=0;C<t.length;C++)if(t[C].includes(g))return C;return t.length},l=g=>{for(const C of t){const L=C.indexOf(g);if(L!==-1)return L}return 999},d=a(n.key),u=a(r.key);if(d!==u)return d-u;const i=l(n.key),c=l(r.key);return i-c}).map((n,r)=>({...n,order:r,rowSpan:n.content?2:1}))},setAllPresent(){this.state.boardData.attendance={absent:[],late:[],exclude:[]},this.state.synced=!1},setAllAbsent(){this.state.boardData.attendance.absent=[...this.state.studentList],this.state.boardData.attendance.late=[],this.state.boardData.attendance.exclude=[],this.state.synced=!1},setAllLate(){this.state.boardData.attendance.absent=[],this.state.boardData.attendance.late=[...this.state.studentList],this.state.boardData.attendance.exclude=[],this.state.synced=!1},setAllExclude(){this.state.boardData.attendance.absent=[],this.state.boardData.attendance.late=[],this.state.boardData.attendance.exclude=[...this.state.studentList],this.state.synced=!1},isPresent(e){const t=this.state.studentList[e],{absent:n,late:r,exclude:a}=this.state.boardData.attendance;return!n.includes(t)&&!r.includes(t)&&!a.includes(t)},isAbsent(e){return this.state.boardData.attendance.absent.includes(this.state.studentList[e])},isLate(e){return this.state.boardData.attendance.late.includes(this.state.studentList[e])},isExclude(e){return this.state.boardData.attendance.exclude.includes(this.state.studentList[e])},setPresent(e){const t=this.state.studentList[e];this.state.boardData.attendance.absent=this.state.boardData.attendance.absent.filter(n=>n!==t),this.state.boardData.attendance.late=this.state.boardData.attendance.late.filter(n=>n!==t),this.state.boardData.attendance.exclude=this.state.boardData.attendance.exclude.filter(n=>n!==t),this.state.synced=!1},setAbsent(e){const t=this.state.studentList[e];this.setPresent(e),this.state.boardData.attendance.absent.push(t),this.state.synced=!1},setLate(e){const t=this.state.studentList[e];this.setPresent(e),this.state.boardData.attendance.late.push(t),this.state.synced=!1},setExclude(e){const t=this.state.studentList[e];this.setPresent(e),this.state.boardData.attendance.exclude.push(t),this.state.synced=!1},async saveAttendance(){try{await this.trySave(!0),this.state.attendanceDialog=!1}catch(e){console.error("保存出勤状态失败:",e),this.$message.error("保存失败","请重试")}},showMessage(e,t="",n="success"){this.$message[n](e,t)},updateSortedItemsCache(e,t){this._sortedItemsCache={key:e,value:t}},handleMouseMove(e){const t=e.currentTarget,n=t.getBoundingClientRect(),r=(e.clientX-n.left)/n.width*100,a=(e.clientY-n.top)/n.height*100;t.style.setProperty("--x",`${r}%`),t.style.setProperty("--y",`${a}%`)},handleTouchMove(e){if(e.touches.length===1){const t=e.touches[0],n=e.currentTarget,r=n.getBoundingClientRect(),a=(t.clientX-r.left)/r.width*100,l=(t.clientY-r.top)/r.height*100;n.style.setProperty("--x",`${a}%`),n.style.setProperty("--y",`${l}%`)}},showConfirmDialog(){return new Promise((e,t)=>{this.confirmDialog={show:!0,resolve:()=>{this.confirmDialog.show=!1,e()},reject:()=>{this.confirmDialog.show=!1,t(new Error("用户取消保存"))}}})},confirmSave(){this.confirmDialog.show=!1,this.confirmDialog.resolve&&this.confirmDialog.resolve(!0)},cancelSave(){this.confirmDialog.show=!1,this.confirmDialog.reject&&this.confirmDialog.reject(new Error("用户取消保存"))},async manualUpload(){return this.trySave(!1)},async handleAttendanceDialogClose(e){!e&&!this.state.synced&&await this.trySave(!0)},toggleFullscreen(){this.state.isFullscreen?this.exitFullscreen():this.enterFullscreen()},enterFullscreen(){const e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullScreen?e.webkitRequestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen()},exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},fullscreenChangeHandler(){this.state.isFullscreen=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)},getStudentStatusColor(e){const t=this.state.studentList[e];return this.state.boardData.attendance.absent.includes(t)?"error":this.state.boardData.attendance.late.includes(t)?"warning":this.state.boardData.attendance.exclude.includes(t)?"grey":"success"},getStudentStatusVariant(e){const t=this.state.studentList[e];return this.state.boardData.attendance.absent.includes(t)||this.state.boardData.attendance.late.includes(t)||this.state.boardData.attendance.exclude.includes(t)?"tonal":"outlined"},getStudentStatusIcon(e){const t=this.state.studentList[e];return this.state.boardData.attendance.absent.includes(t)?"mdi-account-off":this.state.boardData.attendance.late.includes(t)?"mdi-clock-alert":this.state.boardData.attendance.exclude.includes(t)?"mdi-account-cancel":"mdi-account-check"},getStudentStatusText(e){const t=this.state.studentList[e];return this.state.boardData.attendance.absent.includes(t)?"请假":this.state.boardData.attendance.late.includes(t)?"迟到":this.state.boardData.attendance.exclude.includes(t)?"不参与":"到课"},toggleFilter(e){const t=this.attendanceFilter.indexOf(e);t===-1?this.attendanceFilter.push(e):this.attendanceFilter.splice(t,1)},openRandomPicker(){this.$refs.randomPicker&&this.$refs.randomPicker.open()},checkHashForRandomPicker(){window.location.hash==="#random-picker"&&this.$nextTick(()=>{console.log("打开随机点名"),window.location.hash="",this.openRandomPicker()})},parseUrlConfig(){try{const t=new URLSearchParams(window.location.search).get("config");if(!t)return!1;try{const n=this.safeBase64Decode(t),r=JSON.parse(n);console.log("从URL读取配置:",r);const a=[],l={},d={};return this.processSpecialSettings(r,a,l),this.processStandardSettings(r,a,l,d),Object.keys(l).length===0?(console.log("URL配置与当前配置相同，无需应用"),!1):new Promise(u=>{this.urlConfigDialog={show:!0,config:r,changes:a,validSettings:l,icons:d,confirmHandler:()=>{this.urlConfigDialog.show=!1,this.applyUrlConfig(l),u(!0)},cancelHandler:()=>{this.urlConfigDialog.show=!1,u(!1)}}})}catch(n){return console.error("解析URL配置错误:",n),this.$message.error("URL配置错误","无法解析配置数据"),!1}}catch(e){return console.error("处理URL配置错误:",e),!1}},processSpecialSettings(e,t,n){var r,a;if(e.classNumber!==void 0){const l=y("server.classNumber");e.classNumber!==l&&(t.push({key:"server.classNumber",name:"班级",oldValue:l,newValue:e.classNumber,description:((r=X["server.classNumber"])==null?void 0:r.description)||"班级编号",icon:((a=X["server.classNumber"])==null?void 0:a.icon)||"mdi-account-group"}),n["server.classNumber"]=e.classNumber)}e.date!==void 0&&e.date!==this.state.dateString&&(t.push({key:"date",name:"日期",oldValue:this.state.dateString,newValue:e.date,description:"查看的日期",icon:"mdi-calendar"}),n.date=e.date),e.subjects&&Array.isArray(e.subjects)&&(t.push({key:"subjects",name:"科目列表",oldValue:`${this.state.availableSubjects.length}个科目`,newValue:`${e.subjects.length}个科目`,description:"可用科目列表",icon:"mdi-notebook"}),n.subjects=e.subjects)},processStandardSettings(e,t,n,r){Object.entries(e).forEach(([a,l])=>{if(["classNumber","date","subjects"].includes(a))return;let d=a,u=X[a];if(!u&&!a.includes(".")){const i=["server.","display.","theme.","edit.","refresh.","font.","randomPicker."];for(const c of i){const g=`${c}${a}`;if(X[g]){d=g,u=X[g];break}}}if(u){let i=this.convertValueToCorrectType(l,u.type);if(u.validate&&!u.validate(i)){console.warn(`URL配置项 ${d} 的值无效: ${l}`);return}const c=y(d);i!==c&&(t.push({key:d,name:this.getSettingDisplayName(d),oldValue:this.formatSettingValue(c),newValue:this.formatSettingValue(i),description:u.description||d,icon:u.icon||"mdi-cog"}),n[d]=i,r[d]=u.icon||"mdi-cog")}else t.push({key:a,name:this.getSettingDisplayName(a),oldValue:"未知",newValue:this.formatSettingValue(l),description:"自定义配置项",icon:"mdi-cog-outline"}),n[a]=l,r[a]="mdi-cog-outline"})},convertValueToCorrectType(e,t){return t==="boolean"?!!e:t==="number"?Number(e):String(e)},formatSettingValue(e){return typeof e=="boolean"?e?"开启":"关闭":e===""||e===null||e===void 0?"空":e.toString()},getSettingDisplayName(e){const t=e.split("."),n=t[t.length-1];return{provider:"数据提供方",domain:"服务器域名",classNumber:"班级编号",emptySubjectDisplay:"空科目显示方式",dynamicSort:"动态排序",showRandomButton:"随机按钮",showFullscreenButton:"全屏按钮",cardHoverEffect:"卡片悬浮效果",enhancedTouchMode:"增强触摸模式",showAntiScreenBurnCard:"防烧屏卡片",mode:"主题模式",size:"字体大小",autoSave:"自动保存",blockNonTodayAutoSave:"禁止自动保存非当日",refreshBeforeEdit:"编辑前刷新",confirmNonTodaySave:"非当日保存确认",auto:"自动刷新",interval:"刷新间隔"}[n]||n},safeBase64Decode(e){try{const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=t.padEnd(t.length+(4-(t.length%4||4))%4,"="),r=atob(n),a=new Uint8Array(r.length);for(let d=0;d<r.length;d++)a[d]=r.charCodeAt(d);return new TextDecoder("utf-8").decode(a)}catch(t){throw console.error("Base64解码错误:",t),new Error("无法解码配置数据")}},applyUrlConfig(e){for(const[t,n]of Object.entries(e)){if(t==="date"){this.handleDateSelect(n);continue}if(t==="subjects"){Array.isArray(n)?(this.setSubjects(n),re("subjects",n),console.log("[index.vue] Updated subjects via URL config and persisted:",n)):console.warn("[index.vue] Invalid subjects format in URL config:",n);continue}re(t,n),t==="server.classNumber"&&(this.state.classNumber=n)}return this.updateBackendUrl(),this.$message.success("URL配置已应用","已从URL加载配置"),!0}}},Pa={class:"d-flex"},Aa={ref:"gridContainer",class:"grid-masonry"},_a={class:"empty-subjects mt-4"},Ma={key:1,class:"empty-subjects-grid"},La={style:{"white-space":"nowrap"}},Fa={style:{"white-space":"nowrap"}},Ta={style:{"white-space":"nowrap"}},Oa={key:0},ja={style:{"white-space":"nowrap"}},Na={style:{"white-space":"nowrap"}},Ea={key:0},Ia={style:{"white-space":"nowrap"}},Ba={style:{"white-space":"nowrap"}},za={key:0},Ra={style:{"white-space":"nowrap"}},Ua={class:"d-flex flex-wrap mt-2 gap-1"},Ga={class:"d-flex flex-wrap mb-4 gap-2"},Ya={class:"flex-grow-1"},Ha={class:"d-flex align-center"},Wa={class:"text-subtitle-1"},qa={class:"attendance-actions"},Ka={class:"text-subtitle-1"},Ja={class:"text-grey-darken-1"},Xa={class:"text-primary font-weight-medium"};function Qa(e,t,n,r,a,l){const d=Pe("message-log"),u=Pe("random-picker");return f(),w(F,null,[s(et,{class:"no-select"},{prepend:o(()=>[s(ya,{icon:"mdi-home"})]),append:o(()=>[s(b,{icon:"mdi-format-font-size-decrease",variant:"text",onClick:t[0]||(t[0]=i=>l.zoom("out"))}),s(b,{icon:"mdi-format-font-size-increase",variant:"text",onClick:t[1]||(t[1]=i=>l.zoom("up"))}),s(Ut,{modelValue:a.state.datePickerDialog,"onUpdate:modelValue":t[3]||(t[3]=i=>a.state.datePickerDialog=i),"close-on-content-click":!1},{activator:o(({props:i})=>[s(b,j({icon:"mdi-calendar",variant:"text"},i),null,16)]),default:o(()=>[s(N,{border:""},{default:o(()=>[s(Ca,{modelValue:a.state.selectedDateObj,"onUpdate:modelValue":[t[2]||(t[2]=i=>a.state.selectedDateObj=i),l.handleDateSelect],"model-value":a.state.selectedDateObj,color:"primary"},null,8,["modelValue","model-value","onUpdate:modelValue"])]),_:1})]),_:1},8,["modelValue"]),s(b,{icon:"mdi-refresh",variant:"text",loading:a.loading.download,onClick:l.downloadData},null,8,["loading","onClick"]),s(b,{icon:"mdi-bell",variant:"text",badge:l.unreadCount||void 0,"badge-color":l.unreadCount?"error":void 0,onClick:t[4]||(t[4]=i=>e.$refs.messageLog.drawer=!0)},null,8,["badge","badge-color"]),s(b,{icon:"mdi-cog",variant:"text",onClick:t[5]||(t[5]=i=>e.$router.push("/settings"))})]),default:o(()=>[s($e,null,{default:o(()=>[h(k(a.state.classNumber)+" - "+k(l.titleText),1)]),_:1}),s(Q)]),_:1}),v("div",Pa,[s(jt,{class:"main-window flex-grow-1 no-select",fluid:""},{default:o(()=>[v("div",Aa,[s(pe,{name:"grid"},{default:o(()=>[(f(!0),w(F,null,O(l.sortedItems,i=>(f(),w("div",{key:i.key,class:"grid-item",style:Ae({"grid-row-end":`span ${i.rowSpan}`,order:i.order})},[s(N,{border:"",height:"100%",class:"glow-track",onClick:c=>!l.isEditingDisabled&&l.openDialog(i.key),onMousemove:l.handleMouseMove,onTouchmove:l.handleTouchMove},{default:o(()=>[s(q,null,{default:o(()=>[h(k(i.name),1)]),_:2},1024),s(E,{style:Ae(a.state.contentStyle)},{default:o(()=>[s(Me,null,{default:o(()=>[(f(!0),w(F,null,O(l.splitPoint(i.content),c=>(f(),_(Le,{key:c},{default:o(()=>[h(k(c),1)]),_:2},1024))),128))]),_:2},1024)]),_:2},1032,["style"])]),_:2},1032,["onClick","onMousemove","onTouchmove"])],4))),128))]),_:1})],512),v("div",_a,[l.emptySubjectDisplay==="button"?(f(),_(ve,{key:0,divided:"",variant:"outlined"},{default:o(()=>[(f(!0),w(F,null,O(l.unusedSubjects,i=>(f(),_(b,{key:i.key,disabled:l.isEditingDisabled,onClick:c=>l.openDialog(i.key)},{default:o(()=>[s(Y,{start:""},{default:o(()=>t[18]||(t[18]=[h(" mdi-plus ")])),_:1}),h(" "+k(i.name),1)]),_:2},1032,["disabled","onClick"]))),128))]),_:1})):(f(),w("div",Ma,[s(pe,{name:"v-list"},{default:o(()=>[(f(!0),w(F,null,O(l.unusedSubjects,i=>(f(),_(N,{key:i.key,border:"",class:"empty-subject-card",disabled:l.isEditingDisabled,onClick:c=>l.openDialog(i.key)},{default:o(()=>[s(q,{class:"text-subtitle-1"},{default:o(()=>[h(k(i.name),1)]),_:2},1024),s(E,{class:"text-center"},{default:o(()=>[s(Y,{size:"small",color:"grey"},{default:o(()=>t[19]||(t[19]=[h(" mdi-plus ")])),_:1}),t[20]||(t[20]=v("div",{class:"text-caption text-grey"},"点击添加作业",-1))]),_:1})]),_:2},1032,["disabled","onClick"]))),128))]),_:1})]))]),a.state.synced?(f(),_(b,{key:1,color:"success",size:"large",onClick:l.showSyncMessage},{default:o(()=>t[22]||(t[22]=[h(" 同步完成 ")])),_:1},8,["onClick"])):(f(),_(b,{key:0,color:"error",size:"large",loading:a.loading.upload,class:"ml-2",onClick:l.manualUpload},{default:o(()=>t[21]||(t[21]=[h(" 上传 ")])),_:1},8,["loading","onClick"])),l.showRandomPickerButton?(f(),_(b,{key:2,color:"amber","prepend-icon":"mdi-account-question","append-icon":"mdi-dice-multiple",size:"large",class:"ml-2",onClick:l.openRandomPicker},{default:o(()=>t[23]||(t[23]=[h(" 随机点名 ")])),_:1},8,["onClick"])):I("",!0),l.showFullscreenButton?(f(),_(b,{key:3,color:a.state.isFullscreen?"blue-grey":"blue","prepend-icon":a.state.isFullscreen?"mdi-fullscreen-exit":"mdi-fullscreen",size:"large",class:"ml-2",onClick:l.toggleFullscreen},{default:o(()=>[h(k(a.state.isFullscreen?"退出全屏":"全屏显示"),1)]),_:1},8,["color","prepend-icon","onClick"])):I("",!0),l.showAntiScreenBurnCard?(f(),_(N,{key:4,border:"",class:"mt-4 anti-burn-card",color:"primary",variant:"tonal"},{default:o(()=>[s(q,{class:"text-subtitle-1"},{default:o(()=>[s(Y,{start:"",icon:"mdi-shield-check",size:"small"}),t[24]||(t[24]=h(" 屏幕保护技术已启用 "))]),_:1}),s(E,{class:"text-body-2"},{default:o(()=>t[25]||(t[25]=[v("p",null," 本应用采用独立自研的动态像素偏移技术(DPO™)，有效防止LCD屏幕烧屏现象。 ",-1),v("p",{class:"text-caption text-grey"},[h(" *研究显示动态像素偏移技术可以修复屏幕坏点，起到保护屏幕的作用，数据来自实验室。"),v("a",{href:"https://patentscope.wipo.int/search/zh/detail.jsf?docId=CN232281523&_cid=P20-M8L0YX-67061-1",target:"_blank"},"Patent CN108648692 ")],-1),v("p",{class:"text-caption text-grey"}," *技术已自动适配您的设备，无需手动调整 ",-1)])),_:1})]),_:1})):I("",!0)]),_:1}),a.state.studentList&&a.state.studentList.length?(f(),_(oe,{key:0,class:"attendance-area no-select",cols:"1",onClick:t[6]||(t[6]=i=>l.setAttendanceArea())},{default:o(()=>[t[36]||(t[36]=v("h1",null,"出勤",-1)),v("h2",null,[t[26]||(t[26]=v("span",{style:{"white-space":"nowrap"}}," 应到 ",-1)),t[27]||(t[27]=h(": ")),v("span",La,k(a.state.studentList.length-a.state.boardData.attendance.exclude.length)+"人 ",1)]),v("h2",null,[t[28]||(t[28]=v("span",{style:{"white-space":"nowrap"}}," 实到 ",-1)),t[29]||(t[29]=h(": ")),v("span",Fa,k(a.state.studentList.length-a.state.boardData.attendance.absent.length-a.state.boardData.attendance.late.length-a.state.boardData.attendance.exclude.length)+"人 ",1)]),v("h2",null,[t[30]||(t[30]=v("span",{style:{"white-space":"nowrap"}}," 请假 ",-1)),t[31]||(t[31]=h(": ")),v("span",Ta,k(a.state.boardData.attendance.absent.length)+"人 ",1)]),(f(!0),w(F,null,O(a.state.boardData.attendance.absent,(i,c)=>(f(),w("h3",{class:"gray-text",key:"absent-"+c},[a.useDisplay().lgAndUp.value?(f(),w("span",Oa,k(`${c+1}. `),1)):I("",!0),v("span",ja,k(i),1)]))),128)),v("h2",null,[t[32]||(t[32]=v("span",{style:{"white-space":"nowrap"}},"迟到",-1)),t[33]||(t[33]=h(": ")),v("span",Na,k(a.state.boardData.attendance.late.length)+"人 ",1)]),(f(!0),w(F,null,O(a.state.boardData.attendance.late,(i,c)=>(f(),w("h3",{class:"gray-text",key:"late-"+c},[a.useDisplay().lgAndUp.value?(f(),w("span",Ea,k(`${c+1}. `),1)):I("",!0),v("span",Ia,k(i),1)]))),128)),v("h2",null,[t[34]||(t[34]=v("span",{style:{"white-space":"nowrap"}},"不参与",-1)),t[35]||(t[35]=h(": ")),v("span",Ba,k(a.state.boardData.attendance.exclude.length)+"人 ",1)]),(f(!0),w(F,null,O(a.state.boardData.attendance.exclude,(i,c)=>(f(),w("h3",{class:"gray-text",key:"exclude-"+c},[a.useDisplay().lgAndUp.value?(f(),w("span",za,k(`${c+1}. `),1)):I("",!0),v("span",Ra,k(i),1)]))),128))]),_:1})):I("",!0)]),s(ie,{modelValue:a.state.dialogVisible,"onUpdate:modelValue":t[8]||(t[8]=i=>a.state.dialogVisible=i),width:"500","onClick:outside":l.handleClose},{default:o(()=>[s(N,{border:""},{default:o(()=>[s(q,null,{default:o(()=>[h(k(a.state.dialogTitle),1)]),_:1}),s(Nt,null,{default:o(()=>[h(k(l.autoSave?"喵？喵呜！":"写完后点击上传谢谢喵"),1)]),_:1}),s(E,null,{default:o(()=>[s(Gt,{ref:"inputRef",modelValue:a.state.textarea,"onUpdate:modelValue":t[7]||(t[7]=i=>a.state.textarea=i),"auto-grow":"",placeholder:"使用换行表示分条",rows:"5"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue","onClick:outside"]),s(Ft,{modelValue:a.state.snackbar,"onUpdate:modelValue":t[9]||(t[9]=i=>a.state.snackbar=i),timeout:2e3},{default:o(()=>[h(k(a.state.snackbarText),1)]),_:1},8,["modelValue"]),s(ie,{modelValue:a.state.attendanceDialog,"onUpdate:modelValue":[t[15]||(t[15]=i=>a.state.attendanceDialog=i),l.handleAttendanceDialogClose],"max-width":"900","fullscreen-breakpoint":"sm"},{default:o(()=>[s(N,null,{default:o(()=>[s(q,{class:"d-flex align-center"},{default:o(()=>[s(Y,{icon:"mdi-account-group",class:"mr-2"}),t[37]||(t[37]=h(" 出勤状态管理 ")),s(Q),s(K,{color:"primary",size:"small",class:"ml-2"},{default:o(()=>[h(k(a.state.dateString),1)]),_:1})]),_:1}),s(E,null,{default:o(()=>[s(ge,{class:"mb-4"},{default:o(()=>[s(oe,{cols:"12",md:"12"},{default:o(()=>[s(Yt,{modelValue:a.attendanceSearch,"onUpdate:modelValue":[t[10]||(t[10]=i=>a.attendanceSearch=i),e.handleSearchChange],"prepend-inner-icon":"mdi-magnify",label:"搜索学生",hint:"支持筛选姓氏，如输入'孙'可筛选所有姓孙的学生",variant:"outlined",clearable:""},null,8,["modelValue","onUpdate:modelValue"]),v("div",Ua,[(f(!0),w(F,null,O(l.extractedSurnames,i=>(f(),_(b,{key:i.name,variant:a.attendanceSearch===i.name?"elevated":"text",color:a.attendanceSearch===i.name?"primary":"",onClick:c=>a.attendanceSearch=a.attendanceSearch===i.name?"":i.name},{default:o(()=>[h(k(i.name)+" ("+k(i.count)+") ",1)]),_:2},1032,["variant","color","onClick"]))),128))])]),_:1})]),_:1}),v("div",Ga,[v("div",null,[s(K,{value:"present",color:a.attendanceFilter.includes("present")?"success":"",variant:a.attendanceFilter.includes("present")?"elevated":"tonal",class:"px-2 filter-chip",onClick:t[11]||(t[11]=i=>l.toggleFilter("present")),"prepend-icon":"mdi-account-check","append-icon":a.attendanceFilter.includes("present")?"mdi-check":""},{default:o(()=>t[38]||(t[38]=[h(" 到课 ")])),_:1},8,["color","variant","append-icon"]),s(K,{value:"absent",color:a.attendanceFilter.includes("absent")?"error":"",variant:a.attendanceFilter.includes("absent")?"elevated":"tonal",class:"px-2 filter-chip",onClick:t[12]||(t[12]=i=>l.toggleFilter("absent")),"prepend-icon":"mdi-account-off","append-icon":a.attendanceFilter.includes("absent")?"mdi-check":""},{default:o(()=>t[39]||(t[39]=[h(" 请假 ")])),_:1},8,["color","variant","append-icon"]),s(K,{value:"late",color:a.attendanceFilter.includes("late")?"warning":"",variant:a.attendanceFilter.includes("late")?"elevated":"tonal",class:"px-2 filter-chip",onClick:t[13]||(t[13]=i=>l.toggleFilter("late")),"prepend-icon":"mdi-clock-alert","append-icon":a.attendanceFilter.includes("late")?"mdi-check":""},{default:o(()=>t[40]||(t[40]=[h(" 迟到 ")])),_:1},8,["color","variant","append-icon"]),s(K,{value:"exclude",color:a.attendanceFilter.includes("exclude")?"grey":"",variant:a.attendanceFilter.includes("exclude")?"elevated":"tonal",class:"px-2 filter-chip",onClick:t[14]||(t[14]=i=>l.toggleFilter("exclude")),"prepend-icon":"mdi-account-cancel","append-icon":a.attendanceFilter.includes("exclude")?"mdi-check":""},{default:o(()=>t[41]||(t[41]=[h(" 不参与 ")])),_:1},8,["color","variant","append-icon"])])]),s(ge,null,{default:o(()=>[(f(!0),w(F,null,O(l.filteredStudents,i=>(f(),_(oe,{key:i,cols:"12",sm:"6",md:"6",lg:"4"},{default:o(()=>[s(N,{class:"student-card",border:""},{default:o(()=>[s(E,{class:"d-flex align-center pa-2"},{default:o(()=>[v("div",Ya,[v("div",Ha,[s(Et,{color:l.getStudentStatusColor(a.state.studentList.indexOf(i)),size:"24",class:"mr-2"},{default:o(()=>[s(Y,{size:"small"},{default:o(()=>[h(k(l.getStudentStatusIcon(a.state.studentList.indexOf(i))),1)]),_:2},1024)]),_:2},1032,["color"]),v("div",Wa,k(i),1)])]),v("div",qa,[s(b,{color:l.isPresent(a.state.studentList.indexOf(i))?"success":"",icon:"mdi-account-check",size:"small",variant:"text",onClick:c=>l.setPresent(a.state.studentList.indexOf(i)),title:"设为到课"},null,8,["color","onClick"]),s(b,{color:l.isAbsent(a.state.studentList.indexOf(i))?"error":"",icon:"mdi-account-off",size:"small",variant:"text",onClick:c=>l.setAbsent(a.state.studentList.indexOf(i)),title:"设为请假"},null,8,["color","onClick"]),s(b,{color:l.isLate(a.state.studentList.indexOf(i))?"warning":"",icon:"mdi-clock-alert",size:"small",variant:"text",onClick:c=>l.setLate(a.state.studentList.indexOf(i)),title:"设为迟到"},null,8,["color","onClick"]),s(b,{color:l.isExclude(a.state.studentList.indexOf(i))?"grey":"",icon:"mdi-account-cancel",size:"small",variant:"text",onClick:c=>l.setExclude(a.state.studentList.indexOf(i)),title:"设为不参与"},null,8,["color","onClick"])])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}),s(ge,null,{default:o(()=>[s(oe,{cols:"12",md:"12"},{default:o(()=>[s(N,{variant:"tonal",color:"primary",class:"mb-4"},{default:o(()=>[s(E,null,{default:o(()=>[t[46]||(t[46]=v("div",{class:"text-subtitle-2 mb-2"},"批量操作",-1)),s(ve,null,{default:o(()=>[s(b,{color:"success","prepend-icon":"mdi-account-check",onClick:l.setAllPresent},{default:o(()=>t[42]||(t[42]=[h(" 全部到齐 ")])),_:1},8,["onClick"]),s(b,{color:"error","prepend-icon":"mdi-account-off",onClick:l.setAllAbsent},{default:o(()=>t[43]||(t[43]=[h(" 全部请假 ")])),_:1},8,["onClick"])]),_:1}),s(ve,null,{default:o(()=>[s(b,{color:"warning","prepend-icon":"mdi-clock-alert",onClick:l.setAllLate},{default:o(()=>t[44]||(t[44]=[h(" 全部迟到 ")])),_:1},8,["onClick"]),s(b,{color:"grey","prepend-icon":"mdi-account-cancel",onClick:l.setAllExclude},{default:o(()=>t[45]||(t[45]=[h(" 全部不参与 ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(Bt),s(ke,null,{default:o(()=>[s(Q),s(b,{color:"primary",onClick:l.saveAttendance},{default:o(()=>[s(Y,{start:""},{default:o(()=>t[47]||(t[47]=[h("mdi-content-save")])),_:1}),t[48]||(t[48]=h(" 保存 "))]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onUpdate:modelValue"]),s(d,{ref:"messageLog"},null,512),s(ie,{modelValue:a.confirmDialog.show,"onUpdate:modelValue":t[16]||(t[16]=i=>a.confirmDialog.show=i),"max-width":"400"},{default:o(()=>[s(N,null,{default:o(()=>[s(q,{class:"text-h6"},{default:o(()=>t[49]||(t[49]=[h(" 确认保存 ")])),_:1}),s(E,null,{default:o(()=>[h(" 您正在修改 "+k(a.state.dateString)+" 的数据，确定要保存吗？ ",1)]),_:1}),s(ke,null,{default:o(()=>[s(Q),s(b,{color:"grey",variant:"text",onClick:a.confirmDialog.reject},{default:o(()=>t[50]||(t[50]=[h(" 取消 ")])),_:1},8,["onClick"]),s(b,{color:"primary",onClick:a.confirmDialog.resolve},{default:o(()=>t[51]||(t[51]=[h(" 确认保存 ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(u,{ref:"randomPicker","student-list":a.state.studentList,attendance:a.state.boardData.attendance},null,8,["student-list","attendance"]),s(ie,{modelValue:a.urlConfigDialog.show,"onUpdate:modelValue":t[17]||(t[17]=i=>a.urlConfigDialog.show=i),"max-width":"500"},{default:o(()=>[s(N,null,{default:o(()=>[s(q,{class:"text-h6"},{default:o(()=>t[52]||(t[52]=[h(" 确认应用URL配置 ")])),_:1}),s(E,null,{default:o(()=>[t[53]||(t[53]=v("p",null,"以下配置将应用于当前班级：",-1)),s(Me,{density:"compact"},{default:o(()=>[(f(!0),w(F,null,O(a.urlConfigDialog.changes,i=>(f(),_(Le,{key:i.key},{prepend:o(()=>[s(Y,{icon:i.icon,size:"small",class:"mr-2"},null,8,["icon"])]),default:o(()=>[s(zt,{class:"d-flex align-center"},{default:o(()=>[v("span",Ka,k(i.name),1),s(He,{activator:"parent",location:"top"},{default:o(()=>[h(k(i.description||i.key),1)]),_:2},1024)]),_:2},1024),s(Rt,null,{default:o(()=>[v("span",Ja,k(i.oldValue),1),s(Y,{icon:"mdi-arrow-right",size:"small",class:"mx-1"}),v("span",Xa,k(i.newValue),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),s(ke,null,{default:o(()=>[s(Q),s(b,{color:"grey",variant:"text",onClick:a.urlConfigDialog.cancelHandler},{default:o(()=>t[54]||(t[54]=[h(" 取消 ")])),_:1},8,["onClick"]),s(b,{color:"primary",onClick:a.urlConfigDialog.confirmHandler},{default:o(()=>t[55]||(t[55]=[h(" 确认应用 ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}const sn=Be(Va,[["render",Qa]]);export{sn as default};
